<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>–°–±–æ—Ä–Ω–∏–∫ –°—Ç–∏—Ö–æ–≤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent-color: #38bdf8;
            --text-color: #374151;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }

        pre.poem {
            white-space: pre-wrap;
            line-height: 1.6;
            font-family: inherit;
            font-size: 1rem;
            color: var(--text-color);
            margin: 0;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ú–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
        .modal {
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            visibility: hidden;
        }

        .modal.open {
            opacity: 1;
            visibility: visible;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏/—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ */
        .tab.active,
        .sort-btn.active {
            @apply bg-sky-500 text-white shadow-md;
        }

        .tab:not(.active),
        .sort-btn:not(.active) {
            @apply bg-white text-gray-700 hover:bg-gray-100;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ —Å—Ç–∏—Ö–æ–≤ */
        .poem-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .poem-card:hover {
            transform: translateY(-2px);
            @apply shadow-lg;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">

    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <header class="flex flex-col sm:flex-row justify-between items-center py-4 mb-8 border-b border-gray-200">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-4 sm:mb-0">–°–±–æ—Ä–Ω–∏–∫ –°—Ç–∏—Ö–æ–≤</h1>
            <nav class="flex items-center space-x-4">
                {% if current_user.is_authenticated %}
                {% if current_user.is_admin %}
                <span class="text-red-600 font-bold">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>
                <a href="{{ url_for('add_poem') }}" class="text-sky-500 hover:text-sky-600 font-semibold">–î–æ–±–∞–≤–∏—Ç—å
                    —Å—Ç–∏—Ö</a>
                {% endif %}
                <a href="{{ url_for('profile') }}" class="text-gray-700 hover:text-sky-600 font-semibold">–ü—Ä–æ—Ñ–∏–ª—å ({{
                    current_user.username }})</a>
                <a href="{{ url_for('logout') }}" class="text-gray-700 hover:text-sky-600 font-semibold">–í—ã–π—Ç–∏</a>
                {% else %}
                <a href="{{ url_for('login') }}" class="text-sky-500 hover:text-sky-600 font-semibold">–í–æ–π—Ç–∏</a>
                <a href="{{ url_for('register') }}"
                    class="text-sky-500 hover:text-sky-600 font-semibold">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                {% endif %}
            </nav>
        </header>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="mb-4 space-y-2">
            {% for category, message in messages %}
            <div
                class="p-3 text-sm rounded-lg shadow-sm {{ 'bg-green-100 text-green-700' if category == 'success' else 'bg-red-100 text-red-700' }}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <div class="mb-8 p-6 bg-white rounded-xl shadow-lg border border-gray-200">
            <input type="search" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∞–≤—Ç–æ—Ä—É –∏–ª–∏ —Ç–µ–∫—Å—Ç—É..."
                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-sky-500 focus:border-sky-500 transition duration-150 text-lg">

            {% if current_user.is_authenticated %}
            <div class="flex flex-wrap gap-3 justify-center mt-4">
                <button data-filter="unfiltered"
                    class="tab active px-4 py-2 rounded-lg font-semibold transition-colors duration-150 flex items-center space-x-2">
                    <span>–í—Å–µ (<span id="count-all">0</span>)</span>
                    <svg id="icon-unfiltered" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </button>
                <button data-filter="unread"
                    class="tab px-4 py-2 rounded-lg font-semibold transition-colors duration-150 flex items-center space-x-2">
                    <span>–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ (<span id="count-unread">0</span>)</span>
                    <svg id="icon-unread" class="w-4 h-4 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </button>
                <button data-filter="read"
                    class="tab px-4 py-2 rounded-lg font-semibold transition-colors duration-150 flex items-center space-x-2">
                    <span>–ü—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ (<span id="count-read">0</span>)</span>
                    <svg id="icon-read" class="w-4 h-4 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </button>
            </div>
            {% endif %}

            <div id="sort-buttons-container"
                class="flex flex-wrap gap-2 justify-center mt-4 pt-4 border-t border-gray-100">
                <span class="font-medium text-gray-700 mr-2 self-center">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å:</span>
                <button data-sort="title" data-order="asc"
                    class="sort-btn active px-4 py-2 rounded-lg text-sm font-semibold flex items-center space-x-1">
                    <span>–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–ê-–Ø)</span> <span id="arrow-title-asc"></span>
                </button>
                <button data-sort="title" data-order="desc"
                    class="sort-btn px-4 py-2 rounded-lg text-sm font-semibold flex items-center space-x-1">
                    <span>–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–Ø-–ê)</span> <span id="arrow-title-desc"></span>
                </button>
                <button data-sort="length" data-order="asc"
                    class="sort-btn px-4 py-2 rounded-lg text-sm font-semibold flex items-center space-x-1">
                    <span>–ü–æ –¥–ª–∏–Ω–µ (–∫–æ—Ä–æ—á–µ)</span> <span id="arrow-length-asc"></span>
                </button>
                <button data-sort="length" data-order="desc"
                    class="sort-btn px-4 py-2 rounded-lg text-sm font-semibold flex items-center space-x-1">
                    <span>–ü–æ –¥–ª–∏–Ω–µ (–¥–ª–∏–Ω–Ω–µ–µ)</span> <span id="arrow-length-desc"></span>
                </button>
            </div>
        </div>

        <div id="poems-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        </div>

        <p id="no-results-message" class="text-center text-xl text-gray-500 mt-10 hidden">
            –ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É —Å—Ç–∏—Ö–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. üòî
        </p>
    </div>

    <div id="poem-modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6 sm:p-8 transform scale-95 transition-transform duration-300"
            id="modal-content">
            <h2 id="modal-title" class="text-3xl font-bold mb-2 text-gray-900 break-words"></h2>
            <p id="modal-author" class="text-lg text-gray-600 mb-4 italic"></p>
            <div class="h-px bg-gray-200 mb-6"></div>

            <pre id="modal-text" class="poem mb-6 text-base text-gray-800"></pre>

            {% if current_user.is_authenticated %}
            <div class="flex flex-wrap justify-between items-center pt-4 border-t border-gray-100">
                <div id="read-button-wrapper" class="hidden">
                    <button id="toggle-read-btn"
                        class="flex items-center space-x-2 px-4 py-2 rounded-full font-semibold transition-colors duration-200 shadow-md">
                        <svg id="read-icon" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <span id="read-status-text"></span>
                    </button>
                </div>

                {% if current_user.is_admin %}
                <div id="admin-buttons" class="flex space-x-3">
                    <a href="#" id="edit-poem-btn"
                        class="hidden bg-yellow-500 hover:bg-yellow-600 text-white font-semibold px-4 py-2 rounded-lg transition-colors duration-200 shadow-md">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                    <button id="delete-poem-btn"
                        class="hidden bg-red-500 hover:bg-red-600 text-white font-semibold px-4 py-2 rounded-lg transition-colors duration-200 shadow-md">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <button id="close-modal-btn"
                class="absolute top-4 right-4 text-gray-500 hover:text-gray-900 transition-colors duration-150">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>

    <script>
        // –í–ê–ñ–ù–û: Jinja2 –≤—Å—Ç–∞–≤–ª—è–µ—Ç —Å—é–¥–∞ –¥–∞–Ω–Ω—ã–µ –∏–∑ Python!
        const allData = {{ poems | tojson }};
        const readPoemsTitles = new Set({{ current_user.read_poems | tojson if current_user.is_authenticated else '[]' | safe }});
        const isAuthenticated = {{ 'true' if current_user.is_authenticated else 'false' }};
        const isAdmin = {{ 'true' if current_user.is_authenticated and current_user.is_admin else 'false' }};

        // ... –í–∞—à –æ—Å—Ç–∞–ª—å–Ω–æ–π JavaScript-–∫–æ–¥ –Ω–∏–∂–µ ...
    </script>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        let allPoems = [];
        let currentFilter = 'unfiltered'; // unfiltered, read, unread
        let currentSort = { type: 'title', order: 'asc' };

        const poemsContainer = document.getElementById('poems-container');
        const searchInput = document.getElementById('search-input');
        const sortButtonsContainer = document.getElementById('sort-buttons-container');
        const tabButtons = document.querySelectorAll('.tab');
        const noResultsMessage = document.getElementById('no-results-message');

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const modal = document.getElementById('poem-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalAuthor = document.getElementById('modal-author');
        const modalText = document.getElementById('modal-text');
        const closeModalBtn = document.getElementById('close-modal-btn');

        // –≠–ª–µ–º–µ–Ω—Ç—ã –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö
        const readButtonWrapper = document.getElementById('read-button-wrapper');
        const toggleReadBtn = document.getElementById('toggle-read-btn');
        const readStatusText = document.getElementById('read-status-text');
        const readIcon = document.getElementById('read-icon');

        // –≠–ª–µ–º–µ–Ω—Ç—ã –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
        const adminButtons = document.getElementById('admin-buttons');
        const editPoemBtn = document.getElementById('edit-poem-btn');
        const deletePoemBtn = document.getElementById('delete-poem-btn');

        let currentPoem = null; // –¢–µ–∫—É—â–∏–π —Å—Ç–∏—Ö, –æ—Ç–∫—Ä—ã—Ç—ã–π –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ

        // --- 1. –õ–û–ì–ò–ö–ê –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–ò, –§–ò–õ–¨–¢–†–ê–¶–ò–ò –ò –°–û–†–¢–ò–†–û–í–ö–ò ---

        const getStatusText = (isRead) => isRead ? '–ü—Ä–æ—á–∏—Ç–∞–Ω–æ' : '–ù–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ';

        // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∫–æ–Ω–æ–∫ –≤–∫–ª–∞–¥–æ–∫ (—Ñ–∏–ª—å—Ç—Ä–æ–≤)
        const updateTabVisuals = (activeFilter) => {
            tabButtons.forEach(button => {
                const iconId = `icon-${button.dataset.filter}`;
                const icon = document.getElementById(iconId);

                if (icon) {
                    if (button.dataset.filter === activeFilter) {
                        icon.classList.remove('hidden');
                    } else {
                        icon.classList.add('hidden');
                    }
                }
            });
        };

        // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–µ–ª–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        const updateSortButtonLabels = () => {
            document.querySelectorAll('.sort-btn').forEach(btn => {
                const sortType = btn.dataset.sort;
                const sortOrder = btn.dataset.order;
                const arrowId = `arrow-${sortType}-${sortOrder}`;
                const arrowSpan = document.getElementById(arrowId);

                if (arrowSpan) {
                    if (sortType === currentSort.type && sortOrder === currentSort.order) {
                        arrowSpan.innerHTML = sortOrder === 'asc' ? '&#9650;' : '&#9660;'; // ‚ñ≤ –∏–ª–∏ ‚ñº
                        arrowSpan.classList.add('text-white'); // –°—Ç—Ä–µ–ª–∫–∞ –±–µ–ª–∞—è –Ω–∞ —Å–∏–Ω–µ–º —Ñ–æ–Ω–µ
                    } else {
                        arrowSpan.innerHTML = '';
                    }
                }
            });
        };


        const createPoemCard = (poem) => {
            const isRead = readPoemsTitles.has(poem.title);
            const card = document.createElement('div');
            const statusClass = isRead ? 'bg-sky-500 text-white' : 'bg-gray-100 text-gray-700';
            const borderClass = isRead ? 'border-sky-100' : 'border-gray-200';

            card.className = `poem-card cursor-pointer p-6 bg-white rounded-xl shadow-lg border-2 ${borderClass} hover:border-sky-500`;
            card.innerHTML = `
                <h3 class="text-xl font-bold text-gray-900 mb-1 break-words">${poem.title}</h3>
                <p class="text-sm text-gray-500 mb-3 italic">–ê–≤—Ç–æ—Ä: ${poem.author}</p>
                <p class="text-sm text-gray-500">${poem.lineCount} —Å—Ç—Ä–æ–∫</p>
                ${isAuthenticated ? `<span class="inline-block mt-2 px-3 py-1 text-xs font-semibold rounded-full ${statusClass}">
                    ${getStatusText(isRead)}
                </span>` : ''}
            `;
            card.onclick = () => openModal(poem.title);
            return card;
        };

        const filterAndRender = () => {
            const searchText = searchInput.value.toLowerCase();

            let filteredPoems = allPoems.filter(poem => {
                const matchesSearch = poem.title.toLowerCase().includes(searchText) ||
                    poem.author.toLowerCase().includes(searchText) ||
                    poem.text.toLowerCase().includes(searchText);

                if (!matchesSearch) return false;

                if (!isAuthenticated) return true; // –ï—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, —Ñ–∏–ª—å—Ç—Ä–∞ –Ω–µ—Ç

                const isRead = readPoemsTitles.has(poem.title);

                if (currentFilter === 'unread') return !isRead;
                if (currentFilter === 'read') return isRead;

                return true; // 'unfiltered'
            });

            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
            filteredPoems.sort((a, b) => {
                let valA, valB;

                if (currentSort.type === 'length') {
                    valA = a.lineCount;
                    valB = b.lineCount;
                } else { // title
                    valA = a.title.toLowerCase();
                    valB = b.title.toLowerCase();
                }

                if (valA < valB) return currentSort.order === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.order === 'asc' ? 1 : -1;
                return 0;
            });

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
            poemsContainer.innerHTML = '';
            if (filteredPoems.length === 0) {
                noResultsMessage.classList.remove('hidden');
            } else {
                noResultsMessage.classList.add('hidden');
                filteredPoems.forEach(poem => {
                    poemsContainer.appendChild(createPoemCard(poem));
                });
            }
        };

        const updateTabCounts = () => {
            if (!isAuthenticated) return;
            const readCount = allPoems.filter(poem => readPoemsTitles.has(poem.title)).length;
            const unreadCount = allPoems.length - readCount;

            document.getElementById('count-all').textContent = allPoems.length;
            document.getElementById('count-unread').textContent = unreadCount;
            document.getElementById('count-read').textContent = readCount;
        };

        // --- 2. –õ–û–ì–ò–ö–ê –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê ---

        const openModal = (title) => {
            currentPoem = allPoems.find(p => p.title === title);
            if (!currentPoem) return;

            modalTitle.textContent = currentPoem.title;
            modalAuthor.textContent = `–ê–≤—Ç–æ—Ä: ${currentPoem.author}`;
            modalText.textContent = currentPoem.text; // pre-wrap —Å–æ—Ö—Ä–∞–Ω–∏—Ç –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫

            if (isAuthenticated) {
                const isRead = readPoemsTitles.has(title);
                updateModalReadButton(isRead);
                readButtonWrapper.classList.remove('hidden');

                if (isAdmin) {
                    // –ò–°–ü–†–ê–í–õ–ï–ù–û BuildError: –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å
                    editPoemBtn.href = `/edit_poem/${encodeURIComponent(title)}`;
                    editPoemBtn.classList.remove('hidden');
                    deletePoemBtn.classList.remove('hidden');
                }
            } else {
                if (readButtonWrapper) readButtonWrapper.classList.add('hidden');
                if (adminButtons) adminButtons.classList.add('hidden');
            }

            modal.classList.add('open');
        };

        const closeModal = () => {
            modal.classList.remove('open');
            // –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
            if (readButtonWrapper) readButtonWrapper.classList.add('hidden');
            if (editPoemBtn) editPoemBtn.classList.add('hidden');
            if (deletePoemBtn) deletePoemBtn.classList.add('hidden');
            currentPoem = null;
        };

        // --- 3. –õ–û–ì–ò–ö–ê AJAX (–ü—Ä–æ—á–∏—Ç–∞–Ω–æ/–ù–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ) ---

        const updateModalReadButton = (isRead) => {
            if (isRead) {
                toggleReadBtn.classList.remove('bg-gray-100', 'text-gray-700');
                toggleReadBtn.classList.add('bg-sky-500', 'text-white');
                readStatusText.textContent = '–ü—Ä–æ—á–∏—Ç–∞–Ω–æ';
                readIcon.classList.remove('text-gray-700');
                readIcon.classList.add('text-white');
            } else {
                toggleReadBtn.classList.remove('bg-sky-500', 'text-white');
                toggleReadBtn.classList.add('bg-gray-100', 'text-gray-700');
                readStatusText.textContent = '–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ';
                readIcon.classList.remove('text-white');
                readIcon.classList.add('text-gray-700');
            }
        }

        const handleToggleRead = async () => {
            if (!currentPoem) return;

            // –ò–°–ü–†–ê–í–õ–ï–ù–û AJAX: –ò—Å–ø–æ–ª—å–∑—É–µ–º —á–∏—Å—Ç—ã–π URL (–±–µ–∑ title –≤ –ø—É—Ç–∏) –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º title –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞, –∫–∞–∫ –æ–∂–∏–¥–∞–µ—Ç app.py
            const url = `{{ url_for('toggle_read') }}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: currentPoem.title })
                });

                if (response.ok) {
                    const data = await response.json();

                    // –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    const isReadAfterAction = data.action === 'marked';
                    if (isReadAfterAction) {
                        readPoemsTitles.add(currentPoem.title);
                    } else {
                        readPoemsTitles.delete(currentPoem.title);
                    }

                    // –û–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                    updateModalReadButton(readPoemsTitles.has(currentPoem.title));

                    // –û–±–Ω–æ–≤–∏—Ç—å –æ–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å
                    updateTabCounts();
                    filterAndRender();

                    console.log(data.message);
                } else {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ—á—Ç–µ–Ω–∏—è.');
                }
            } catch (error) {
                console.error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
            }
        };

        const handleDeletePoem = async () => {
            if (!currentPoem || !confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å—Ç–∏—Ö "${currentPoem.title}"?`)) return;

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å, —Ç–∞–∫ –∫–∞–∫ /delete_poem/<title> —Ç—Ä–µ–±—É–µ—Ç title –≤ URL
            const url = `/delete_poem/${encodeURIComponent(currentPoem.title)}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                });

                if (response.ok) {
                    // –£–¥–∞–ª–∏—Ç—å —Å—Ç–∏—Ö –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–∞ –∏ –∏–∑ –Ω–∞–±–æ—Ä–∞ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
                    allPoems = allPoems.filter(p => p.title !== currentPoem.title);
                    readPoemsTitles.delete(currentPoem.title);

                    // –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –∑–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                    updateTabCounts();
                    filterAndRender();
                    closeModal();

                    // –û–ø–æ–≤–µ—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                    alert('–°—Ç–∏—Ö —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!');
                } else {
                    const errorData = await response.json();
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å—Ç–∏—Ö–∞:', errorData.message);
                    alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å—Ç–∏—Ö–∞: ${errorData.message}`);
                }
            } catch (error) {
                console.error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:', error);
                alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏.');
            }
        };


        // --- 4. –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ---

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (–≤–∫–ª–∞–¥–æ–∫)
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                document.querySelector('.tab.active').classList.remove('active');
                button.classList.add('active');
                currentFilter = button.dataset.filter;

                updateTabVisuals(currentFilter); // –û–±–Ω–æ–≤–∏—Ç—å –∏–∫–æ–Ω–∫—É
                filterAndRender();
            });
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        closeModalBtn.addEventListener('click', closeModal);
        if (toggleReadBtn) toggleReadBtn.addEventListener('click', handleToggleRead);
        if (deletePoemBtn) deletePoemBtn.addEventListener('click', handleDeletePoem);

        searchInput.addEventListener('input', filterAndRender);

        sortButtonsContainer.addEventListener('click', (e) => {
            const targetButton = e.target.closest('button.sort-btn');
            if (!targetButton) return;

            currentSort.type = targetButton.dataset.sort;
            currentSort.order = targetButton.dataset.order;

            sortButtonsContainer.querySelector('.active').classList.remove('active');
            targetButton.classList.add('active');

            updateSortButtonLabels(); // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–µ–ª–∫–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            filterAndRender();
        });

        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal();
            }
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && modal.classList.contains('open')) {
                closeModal();
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = () => {
            // –î–æ–±–∞–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Å—Ç—Ä–æ–∫ –≤ –¥–∞–Ω–Ω—ã–µ —Å—Ç–∏—Ö–æ–≤
            allPoems = allData.map(poem => ({
                ...poem,
                lineCount: poem.text.split('\n').length
            }));

            // –ó–∞–ø—É—Å–∫–∞–µ–º —Å—á–µ—Ç—á–∏–∫–∏, –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫—É
            updateTabCounts();
            updateTabVisuals(currentFilter); // –ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞—á–∞–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä (–í—Å–µ)
            updateSortButtonLabels(); // –ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞—á–∞–ª—å–Ω—É—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É (–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é –ê-–Ø)
            filterAndRender();
        };
    </script>
</body>

</html>