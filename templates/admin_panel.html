<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>–ü–∞–Ω–µ–ª—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
            color: #374151;
        }

        .modal {
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            visibility: hidden;
        }

        .modal.open {
            opacity: 1;
            visibility: visible;
        }

        .poem-text {
            white-space: pre-wrap;
            line-height: 1.5;
        }

        .sortable:hover {
            cursor: pointer;
            background-color: #f3f4f6;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">

    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <header class="flex flex-col sm:flex-row justify-between items-center py-4 mb-8 border-b border-gray-200">
            <h1 class="text-3xl font-extrabold text-red-600 mb-4 sm:mb-0">–ü–∞–Ω–µ–ª—å –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è –°—Ç–∏—Ö–∞–º–∏</h1>
            <nav class="flex items-center space-x-4">
                <a href="{{ request.url_for('read_root') }}" class="text-sky-500 hover:text-sky-600 font-semibold">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
            </nav>
        </header>
        
        <div id="flash-messages" class="mb-4 space-y-2"></div>

        <div class="mb-8 p-6 bg-white rounded-xl shadow-lg border border-gray-200">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                <input type="search" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∞–≤—Ç–æ—Ä—É –∏–ª–∏ —Ç–µ–∫—Å—Ç—É..."
                    class="w-full md:w-2/3 px-4 py-3 border border-gray-300 rounded-xl focus:ring-sky-500 focus:border-sky-500 transition duration-150 text-lg mb-4 md:mb-0">

                <button id="add-new-poem-btn"
                    class="w-full md:w-auto bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200 shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    + –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å—Ç–∏—Ö
                </button>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                    <thead>
                        <tr class="text-left bg-gray-50 border-b border-gray-200 text-sm text-gray-700 uppercase">
                            <th id="sort-title" data-sort="title" data-order="asc"
                                class="sortable px-4 py-3 font-semibold rounded-tl-lg">–ù–∞–∑–≤–∞–Ω–∏–µ
                                <span class="title-order text-sky-500 ml-1">‚ñ≤</span>
                            </th>
                            <th id="sort-author" data-sort="author" data-order="none"
                                class="sortable px-4 py-3 font-semibold">–ê–≤—Ç–æ—Ä</th>
                            <th id="sort-length" data-sort="length" data-order="none"
                                class="sortable px-4 py-3 font-semibold text-center">–°—Ç—Ä–æ–∫</th>
                            <th class="px-4 py-3 font-semibold text-center rounded-tr-lg">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="poems-table-body" class="divide-y divide-gray-100">
                    </tbody>
                </table>
                <p id="no-results-message" class="text-center text-lg text-gray-500 py-10 hidden">
                    –°—Ç–∏—Ö–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.
                </p>
            </div>
        </div>
    </div>


    <div id="poem-modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-xl max-h-[90vh] overflow-y-auto p-6 sm:p-8 transform scale-95 transition-transform duration-300"
            id="modal-content">
            <h2 id="modal-heading" class="text-2xl font-bold mb-6 text-gray-900 text-center"></h2>

            <form id="poem-form">
                <input type="hidden" id="original-title" name="original-title">

                <div class="mb-4">
                    <label for="title" class="block text-sm font-medium text-gray-700 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="title" name="title" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-sky-500 focus:border-sky-500 transition duration-150">
                </div>

                <div class="mb-4">
                    <label for="author" class="block text-sm font-medium text-gray-700 mb-1">–ê–≤—Ç–æ—Ä</label>
                    <input type="text" id="author" name="author" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-sky-500 focus:border-sky-500 transition duration-150">
                </div>

                <div class="mb-6">
                    <label for="text" class="block text-sm font-medium text-gray-700 mb-1">–¢–µ–∫—Å—Ç —Å—Ç–∏—Ö–∞</label>
                    <textarea id="text" name="text" rows="10" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-sky-500 focus:border-sky-500 transition duration-150"
                        placeholder="–ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç–¥–µ–ª–µ–Ω–∞ –ø–µ—Ä–µ–≤–æ–¥–æ–º —Å—Ç—Ä–æ–∫–∏."></textarea>
                </div>

                <button type="submit" id="modal-submit-btn"
                    class="w-full bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 rounded-lg transition-colors duration-200 shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <div id="modal-error" class="text-red-500 text-sm text-center mt-3 hidden"></div>
            </form>

            <button id="close-modal-btn"
                class="absolute top-4 right-4 text-gray-500 hover:text-gray-900 transition-colors duration-150">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>


    <script>
        let allPoems = [];
        let filteredPoems = [];
        let isEditing = false; 
        let currentSort = { type: 'title', order: 'asc' };

        const searchInput = document.getElementById('search-input');
        const poemsTableBody = document.getElementById('poems-table-body');
        const noResultsMessage = document.getElementById('no-results-message');
        const modal = document.getElementById('poem-modal');
        const modalForm = document.getElementById('poem-form');
        const modalHeading = document.getElementById('modal-heading');
        const modalSubmitBtn = document.getElementById('modal-submit-btn');
        const modalError = document.getElementById('modal-error');
        const originalTitleInput = document.getElementById('original-title');

        function showMessage(message, category = 'success') {
            const container = document.getElementById('flash-messages');
            if (!container) return;

            const div = document.createElement('div');
            div.className = `p-3 text-sm rounded-lg shadow-sm ${category === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            div.textContent = message;
            container.prepend(div);

            setTimeout(() => div.remove(), 5000);
        }

        function closeModal() {
            modal.classList.remove('open');
            modalForm.reset();
            originalTitleInput.value = '';
            modalError.classList.add('hidden');
        }

        function openModal(poem = null) {
            modalForm.reset();
            modalError.classList.add('hidden');

            if (poem) {
                isEditing = true;
                modalHeading.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å: "${poem.title}"`;
                modalSubmitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
                document.getElementById('title').value = poem.title;
                document.getElementById('author').value = poem.author;
                document.getElementById('text').value = poem.text;
                originalTitleInput.value = poem.title;
            } else {
                isEditing = false;
                modalHeading.textContent = '–î–æ–±–∞–≤–∏—Ç—å –ù–æ–≤—ã–π –°—Ç–∏—Ö üìù';
                modalSubmitBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∏—Ö';
                originalTitleInput.value = '';
            }

            modal.classList.add('open');
        }

        function createTableRow(poem) {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            tr.dataset.title = poem.title;

            tr.innerHTML = `
                <td class="px-4 py-3 font-medium text-gray-900 break-words">${poem.title}</td>
                <td class="px-4 py-3 text-gray-700">${poem.author}</td>
                <td class="px-4 py-3 text-gray-700 text-center">${poem.line_count}</td>
                <td class="px-4 py-3 text-center whitespace-nowrap">
                    <button data-title="${poem.title}" data-action="edit"
                        class="text-yellow-600 hover:text-yellow-800 font-semibold px-3 py-1 rounded-lg transition-colors duration-150 text-sm">
                        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                    <button data-title="${poem.title}" data-action="delete"
                        class="text-red-600 hover:text-red-800 font-semibold px-3 py-1 rounded-lg transition-colors duration-150 text-sm ml-2">
                        –£–¥–∞–ª–∏—Ç—å
                    </button>
                </td>
            `;
            return tr;
        }

        function sortPoems(poems) {
            poems.sort((a, b) => {
                let valA, valB;

                if (currentSort.type === 'length') {
                    valA = a.line_count;
                    valB = b.line_count;
                } else {
                    valA = a[currentSort.type].toLowerCase();
                    valB = b[currentSort.type].toLowerCase();
                }

                if (valA < valB) return currentSort.order === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.order === 'asc' ? 1 : -1;
                return 0;
            });
            return poems;
        }

        function renderTable(poems) {
            poemsTableBody.innerHTML = '';
            if (poems.length === 0) {
                noResultsMessage.classList.remove('hidden');
            } else {
                noResultsMessage.classList.add('hidden');
                poems.forEach(poem => {
                    poemsTableBody.appendChild(createTableRow(poem));
                });
            }
        }

        function filterAndRender() {
            const searchText = searchInput.value.toLowerCase().trim();

            filteredPoems = allPoems.filter(poem => {
                return poem.title.toLowerCase().includes(searchText) ||
                    poem.author.toLowerCase().includes(searchText) ||
                    poem.text.toLowerCase().includes(searchText);
            });

            const sortedPoems = sortPoems(filteredPoems);
            renderTable(sortedPoems);
        }

        async function loadPoems() {
            try {
                const response = await fetch("{{ request.url_for('get_all_poems_api') }}");
                if (!response.ok) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∏—Ö–∏.');
                }
                const data = await response.json();
                allPoems = data.poems || [];
                filterAndRender();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                showMessage('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å—Ç–∏—Ö–æ–≤.', 'error');
            }
        }

        async function handleSubmit(event) {
            event.preventDefault();
            modalError.classList.add('hidden');
            modalSubmitBtn.disabled = true;

            const title = document.getElementById('title').value.trim();
            const author = document.getElementById('author').value.trim();
            const text = document.getElementById('text').value.trim();
            const originalTitle = originalTitleInput.value;

            if (!title || !author || !text) {
                modalError.textContent = '–í—Å–µ –ø–æ–ª—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω—ã.';
                modalError.classList.remove('hidden');
                modalSubmitBtn.disabled = false;
                return;
            }

            let url, method;

            if (isEditing) {
                url = "{{ request.url_for('edit_poem_post', original_title='TEMP') }}".replace('TEMP', encodeURIComponent(originalTitle));
                method = 'POST';
            } else {
                url = "{{ request.url_for('add_poem_post') }}";
                method = 'POST';
            }

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, author, text })
                });

                const data = await response.json();

                if (response.ok) {
                    const newPoem = data.poem;

                    if (isEditing) {
                        allPoems = allPoems.filter(p => p.title !== originalTitle);
                    }
                    allPoems.push(newPoem);

                    showMessage(data.message, 'success');
                    closeModal();
                    filterAndRender();
                } else {
                    modalError.textContent = data.detail || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.';
                    modalError.classList.remove('hidden');
                }
            } catch (error) {
                modalError.textContent = '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.';
                modalError.classList.remove('hidden');
            } finally {
                modalSubmitBtn.disabled = false;
            }
        }

        async function handleDelete(title) {
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å—Ç–∏—Ö "${title}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ –∏ —É–¥–∞–ª–∏—Ç –µ–≥–æ —É –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π!`)) {
                return;
            }

            const url = `/delete_poem/${encodeURIComponent(title)}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                });

                if (response.ok) {
                    allPoems = allPoems.filter(p => p.title !== title);
                    showMessage(`–°—Ç–∏—Ö "${title}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.`, 'success');
                    filterAndRender();
                } else {
                    const errorData = await response.json();
                    showMessage(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ${errorData.detail}`, 'error');
                }
            } catch (error) {
                showMessage('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏.', 'error');
            }
        }

        window.onload = () => {
            loadPoems();

            document.getElementById('add-new-poem-btn').addEventListener('click', () => openModal());
            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            modal.addEventListener('click', (event) => {
                if (event.target === modal) closeModal();
            });
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && modal.classList.contains('open')) closeModal();
            });

            searchInput.addEventListener('input', filterAndRender);
            modalForm.addEventListener('submit', handleSubmit);

            poemsTableBody.addEventListener('click', (e) => {
                const targetBtn = e.target.closest('button[data-action]');
                if (!targetBtn) return;

                const title = targetBtn.dataset.title;
                const poem = allPoems.find(p => p.title === title);

                if (targetBtn.dataset.action === 'edit' && poem) {
                    openModal(poem);
                } else if (targetBtn.dataset.action === 'delete') {
                    handleDelete(title);
                }
            });

            document.querySelectorAll('.sortable').forEach(header => {
                header.addEventListener('click', () => {
                    const sortType = header.dataset.sort;
                    let sortOrder = header.dataset.order;

                    if (currentSort.type === sortType) {
                        sortOrder = (currentSort.order === 'asc' || currentSort.order === 'none') ? 'desc' : 'asc';
                    } else {
                        sortOrder = 'asc';
                    }

                    currentSort = { type: sortType, order: sortOrder };

                    document.querySelectorAll('.sortable').forEach(h => {
                        h.dataset.order = 'none';
                        h.querySelector('span') && h.querySelector('span').remove();
                    });

                    header.dataset.order = sortOrder;
                    const orderSymbol = sortOrder === 'asc' ? '‚ñ≤' : '‚ñº';
                    const orderSpan = document.createElement('span');
                    orderSpan.className = `${sortType}-order text-sky-500 ml-1`;
                    orderSpan.textContent = orderSymbol;
                    header.appendChild(orderSpan);

                    filterAndRender();
                });
            });
        };
    </script>
</body>

</html>